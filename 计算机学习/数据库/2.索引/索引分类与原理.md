# 索引分类与原理
#数据库  #索引 #io
 [MySQL数据库阶段学习目录](https://www.cnblogs.com/clschao/articles/10065275.html)
## 索引本质 
MySQL官方对索引的定义为：索引（Index）是帮助MySQL高效获取数据的数据结构。

**本质：通过不断地缩小想要获取数据的范围来筛选出最终想要的结果，同时把随机的事件变成顺序的事件，也就是说，有了这种索引机制，我们可以总是用同一种查找方式来锁定数据。**

索引虽然会加快查询，但是会降低写入的效率
> **索引的影响**
> 1、在表中有大量数据的前提下，创建索引速度会很慢
> 2、在索引创建完毕后，对表的查询性能会发幅度提升，但是写性能会降低

## 扩展 ：磁盘IO 的慢与预读
> 机械硬盘 读取数据花费的时间 可以分为 寻道时间、旋转延迟、传输时间。其中 寻道时间、旋转延迟需要做机械运动，耗时很大 （4ms 5ms ）传输时间相比可以忽略 （≈0.1ms）

计算机硬件延迟的对比图
![[计算机硬件延迟的对比图.png]]

考虑到磁盘IO是非常高昂的操作，计算机操作系统做了一些优化，**当一次IO时，不光把当前磁盘地址的数据，而是把相邻的数据也都读取到内存缓冲区内**。
因为局部预读性原理告诉我们，当计算机访问一个地址的数据的时候，与其相邻的数据也会很快被访问到。
每一次IO读取的数据我们称之为一页(page)。具体一页有多大数据跟操作系统有关，一般为4k或8k，也就是我们读取一页内的数据时候，实际上才发生了一次IO，这个理论对于索引的数据结构设计非常有帮助

## Mysql MyISAM索引
是一颗B+Tree data域保存数据记录的地址。索引文件与数据文件分离。
## Mysql InnoDB聚集索引与辅助索引
InnoDB的索引也是一颗B+Tree但具体实现方式却与MyISAM截然不同。

第一个重大区别是InnoDB的数据文件本身就是索引文件。
  - 从上文知道，MyISAM索引文件和数据文件是分离的，索引文件仅保存数据记录的地址。而在InnoDB中，表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录。这个索引的key是数据表的主键，因此InnoDB表数据文件本身就是主索引。

第二个与MyISAM索引的不同是InnoDB的辅助索引data域存储相应记录主键的值而不是地址。
### 1. 聚集索引
InnoDB存储引擎表示索引组织表，即表中数据按照主键顺序存放。而聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子结点存放的即为整张表的行记录数据，也将聚集索引的叶子结点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。同B+树数据结构一样，每个数据页都通过一个双向链表来进行链接。
    
> 如果未定义主键，MySQL取第一个唯一索引（unique）而且只含非空列（NOT NULL）作为主键，InnoDB使用它作为聚簇索引。
 > 如果没有这样的列，InnoDB就自己产生一个这样的ID值，它有六个字节，而且是隐藏的，使其作为聚簇索引。

由于实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚集索引。在多少情况下，查询优化器倾向于采用聚集索引。因为聚集索引能够在B+树索引的叶子节点上直接找到数据。此外由于定义了数据的逻辑顺序，聚集索引能够特别快地访问针对范围值得查询。

### 2. 辅助索引
表中除了聚集索引外其他索引都是辅助索引.与聚集索引的区别是：辅助索引的叶子节点不包含行记录的全部数据。
叶子节点存放的是对应的那条数据的主键字段的值，除了包含键值以外，每个叶子节点中的索引行中还包含一个书签（bookmark），其实这个书签你可以理解为是一个{'name字段'，name的值，主键id值}的这么一个数据。

 #### 2.1 覆盖索引与回表
如果可以 直接就可以在辅助索引的叶子节点找到对应的name值，比如：select name from tb1 where name='xx'，即:辅助索引的叶子节点就能找到你想找的数据这样的操作可称为覆盖索引 (或称索引覆盖)。
反正如果不能，就需要根据辅助索引的叶子节点中保存的主键id的值再去通过聚集索引来找到完整的一条记录。这种操作称为回表操作，就是从头再回去查一遍。其效率也不低

辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引，但只能有一个聚集索引。
当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶子级别的指针获得只想主键索引的主键，然后再通过主键索引来找到一个完整的行记录，这种查找的效率也是非常高。

#### 为什么InnoDB不建议使用过长的字段作为主键？推荐使用单调变化的字段作为主键？
> 1. 因为所有辅助索引都引用主索引，过长的主索引会令辅助索引变得过大。
> 2. 用非单调的字段作为主键在InnoDB中不是个好主意，因为InnoDB数据文件本身是一颗B+Tree，非单调的主键会造成在插入新记录时数据文件为了维持B+Tree的特性而频繁的分裂调整，十分低效，而使用自增字段作为主键则是一个很好的选择。